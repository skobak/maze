<!DOCTYPE html>
<html>

<head>
    <title>Maze</title>
    <script>
        // DOM references
        let complexityInput;
        let speedInput;
        let rowsInput;
        let columnsInput;
        let gridDiv;
        let stepCountDiv;
        let deadEndsCountDiv;
        let resultDiv;

        // Temprorary variables
        let timeoutRef = null;
        let maxC = 30;
        let maxR = 30;
        let width = 10;
        let height = 10;
        let steps = []; // [ {r,c} ]
        let speedMls = 20;
        let complexity = 7; // 0 - 10
        let stepCount = 0;
        let deadEndsCount = 0;

        // Drawing part
        function getCellComponent(isBlock, r, i) {
            const div = document.createElement('div');
            div.style.width = width + 'px';
            div.style.height = height + 'px';
            div.style.border = '1px solid black';
            div.style.display = 'inline-block';
            div.style.margin = '0px';
            div.setAttribute('id', 'r' + r + 'c' + i);
            div.setAttribute('class', isBlock ? 'block' : 'empty');
            return div
        }

        function drawRow(r, c) {
            const rowDiv = document.createElement('div');
            rowDiv.style.height = height + 'px';
            for (let i = 0; i < c; i++) {
                let isBlock = (i === 0 && c == 0) || (i === maxR - 1 && c === maxC - 1) ? 0 : Math.round(Math.random() * (11 - complexity)) === 1;
                rowDiv.appendChild(getCellComponent(!!isBlock, r, i));
            }
            return rowDiv;
        }

        function drawGrip(r, c) {
            gridDiv.innerHTML = '';
            for (let i = 0; i < r; i++) {
                gridDiv.appendChild(drawRow(i, c));
            }
        }

        function updateCounts() {
            stepCountDiv.innerHTML = stepCount;
            deadEndsCountDiv.innerHTML = deadEndsCount;
        }

        function drawPathSeeker(r, c) {
            stepCount++;
            updateCounts();
            removePathSeekerFromGrid();
            const square = document.getElementById('r' + r + 'c' + c);
            const pathSeeker = document.createElement('div');
            pathSeeker.style.width = width / 2 + 'px';
            pathSeeker.style.height = height / 2 + 'px';
            pathSeeker.style.margin = width / 4 + 'px ' + height / 4 + 'px';
            pathSeeker.setAttribute('id', 'pathSeeker');
            pathSeeker.setAttribute('class', 'pathSeeker');
            square.classList.add('trace')
            square.appendChild(pathSeeker);
        }

        function markAsDeadEnd(r, c) {
            deadEndsCount++;
            const suqare = document.getElementById('r' + r + 'c' + c);
            suqare.classList.add('dead-end');
        }

        function printResult(text) {
            resultDiv.innerHTML = text;
        }

        // Cleaning part
        function removePathSeekerFromGrid() {
            const pathSeekers = document.getElementsByClassName('pathSeeker')
            for (let i = 0; i < pathSeekers.length; i++) {
                pathSeekers[i].remove();
            }
        }

        function removeAllTraces() {
            const traces = document.getElementsByClassName('empty')
            for (let i = 0; i < traces.length; i++) {
                traces[i].attributes['class'].value = 'empty';
            }

        }

        // Main logic
        // We start at certain point and try to go right or down. If that not possible
        // we go back to a stack of steps and try again, if next move has not been mark as traced
        // if history of steps is empty = we are done without success
        // if we reach the left bottom corner = we are done with success
        function findPath(r, c) {
            drawPathSeeker(r, c)
            if (r == maxR - 1 && c == maxC - 1) {
                printResult('bingo')
                return;
            }
            let rightSquare = document.getElementById('r' + r + 'c' + (c + 1));
            let bottomSquare = document.getElementById('r' + (r + 1) + 'c' + c);

            if (rightSquare && rightSquare.classList.contains('empty') && !rightSquare.classList.contains('dead-end')) {
                timeoutRef = setTimeout(() => findPath(r, c + 1), speedMls);
                steps.push({
                    r,
                    c
                });
            } else if (bottomSquare && bottomSquare.classList.contains('empty') && !bottomSquare.classList.contains('dead-end')) {
                timeoutRef = setTimeout(() => findPath(r + 1, c), speedMls);
                steps.push({
                    r,
                    c
                });
            } else {
                markAsDeadEnd(r, c);
                if (steps.length > 0) {
                    const lastStep = steps.pop();
                    timeoutRef = setTimeout(() => findPath(lastStep.r, lastStep.c), speedMls);
                } else {
                    printResult('no way');
                    return;
                }
            }
        }

        function startAgain() {
            if (timeoutRef !== null) {
                clearTimeout(timeoutRef);
            }
            stepCount = 0;
            deadEndsCount = 0;
            steps = [];
            printResult('')
            removeAllTraces();
            findPath(0, 0)
        }

        function initDomElement() {
            gridDiv = document.getElementById('grid');
            complexityInput = document.getElementById('complexityInput');
            speedInput = document.getElementById('speedInput');
            rowsInput = document.getElementById('rowsInput');
            columnsInput = document.getElementById('columnsInput');
            stepCountDiv = document.getElementById('stepCount')
            deadEndsCountDiv = document.getElementById('deadEndsCount')
            resultDiv = document.getElementById('result')
        }

        function initZoomLevel() {
            width = window.outerWidth / 3 / maxR;
            height = window.outerWidth / 3 / maxC;
        }

        function setParams() {
            if (complexityInput.value === '') {
                complexityInput.value = complexity
            } else {
                complexity = parseInt(complexityInput.value)
            }
            if (speedInput.value === '') {
                speedInput.value = speedMls
            } else {
                speedMls = parseInt(speedInput.value)
            }
            if (rowsInput.value === '') {
                rowsInput.value = maxR
            } else {
                maxR = parseInt(rowsInput.value)
            }
            if (columnsInput.value === '') {
                columnsInput.value = maxC
            } else {
                maxC = parseInt(columnsInput.value)
            }
        }

        function reBuild() {
            setParams();
            initZoomLevel();
            drawGrip(maxR, maxC);
            startAgain()
        }

        function stop() {
            if (timeoutRef !== null) {
                clearTimeout(timeoutRef);
            }
        }

        window.onload = function() {
            initDomElement();
            reBuild();
        }
    </script>
</head>

<style>
     :root {
        --dead-end-color: rgba(255, 208, 0);
        --trace-color: rgb(0, 140, 255);
        --empty-color: rgb(89, 255, 158);
        --block-color: rgba(255, 0, 0);
    }
    
    .trace {
        background-color: var(--trace-color)!important;
    }
    
    .dead-end {
        background-color: var(--dead-end-color)!important;
    }
    
    .block {
        background-color: var(--block-color)!important;
    }
    
    .empty {
        background-color: var(--empty-color)
    }
    
    #grid {
        width: 50vw;
    }
    
    #log {
        width: 100%;
        border: 1px solid black;
        background: #dadada;
        margin-top: 10px;
        padding: 10px;
    }
    
    #pathSeeker {
        background-color: rgb(255, 255, 255);
        border-radius: 50%;
    }
    
    .inputField {
        margin: 10px 0px;
    }
    
    .square {
        width: 10px;
        height: 10px;
        display: inline-block;
    }
    
    .square.block {
        background-color: var(--block-color);
    }
    
    .square.deadEnd {
        background-color: var(--dead-end-color)
    }
    
    .square.trace {
        background-color: var(--trace-color)
    }
</style>

<body>
    <div style="display:flex; gap:20px;">
        <div id="grid"></div>
        <div>
            <h1>Pure JavaScript/HTML/CSS maze challenge</h1>
            <p>The path seeker can only move down and right</p>
            <p>Set the params you want and click: 'Re-build'</p>
            <div>
                <p><span class="square block"></span> - blocker</p>
                <p><span class="square deadEnd"></span> - dead end</p>
                <p><span class="square trace"></span> - trace</p>
                <button onclick="startAgain()">Restart</button>
                <button onclick="reBuild()">Re-build</button>
                <button onclick="stop()">Stop</button>
                <div class="inputField">
                    <label for="speed">Speed(milliseconds)</label>
                    <input name="speed" type="number" min="1" max="1000" id="speedInput">
                </div>
                <div class="inputField">
                    <label for="complexity">Complexity (1 - easy, 10 - hard)</label>
                    <input name="complexity" type="number" min="1" max="10" id="complexityInput">
                </div>
                <div class="inputField">
                    <label for="rows">Rows(1-100)</label>
                    <input name="rows" type="number" min="1" max="100" id="rowsInput">
                </div>
                <div class="inputField">
                    <label for="columns">Columns(1-100)</label>
                    <input name="columbs" type="number" min="1" max="100" id="columnsInput">
                </div>
                <h2>Log</h2>
                <div id="log">
                    <h2 id="result"></h2>
                    <div><label>Steps: </label>
                        <div id="stepCount">0</div>
                    </div>
                    <div><label>Dead-ends: </label>
                        <div id="deadEndsCount">0</div>
                    </div>
                </div>
            </div>
        </div>

</html>